const r="scrapeflow_configs",i="scrapeflow_data";chrome.runtime.onMessage.addListener((e,t,n)=>((async()=>{switch(e.type){case"GET_CONFIGS":return l();case"SAVE_CONFIG":return g(e.payload);case"DELETE_CONFIG":return f(e.payload);case"GET_DATA":return u();case"SAVE_DATA":return w(e.payload);case"EXPORT_CSV":return p(e.payload);default:throw new Error(`Unknown message type: ${e.type}`)}})().then(n).catch(o=>n({error:o.message})),!0));async function l(){return(await chrome.storage.local.get(r))[r]||[]}async function g(e){const t=await l(),n=t.findIndex(a=>a.id===e.id);return n>=0?t[n]={...e,updatedAt:Date.now()}:t.push({...e,createdAt:Date.now(),updatedAt:Date.now()}),await chrome.storage.local.set({[r]:t}),e}async function f(e){const n=(await l()).filter(a=>a.id!==e);await chrome.storage.local.set({[r]:n})}async function u(){return(await chrome.storage.local.get(i))[i]||[]}async function w(e){const t=await u();return t.unshift(e),t.length>100&&t.pop(),await chrome.storage.local.set({[i]:t}),e}function p(e){if(!e.rows.length)return{success:!1,csv:""};const t=Object.keys(e.rows[0]),n=e.rows.map(o=>t.map(d=>{const c=o[d];if(c==null)return"";const s=String(c);return s.includes(",")||s.includes('"')||s.includes(`
`)?`"${s.replace(/"/g,'""')}"`:s}).join(","));return{success:!0,csv:[t.join(","),...n].join(`
`)}}console.log("ScrapeFlow background script loaded");
